---
# To install the Networking components
# See http://docs.openstack.org/kilo/install-guide/install/apt/content/neutron-network-node.html

- name: install the Networking components
  apt:
    name: "{{ item }}"
  with_items:
  - neutron-plugin-ml2
  - neutron-plugin-openvswitch-agent
  - neutron-l3-agent
  - neutron-dhcp-agent
  - neutron-metadata-agent

# To configure the Networking common components
# Edit the /etc/neutron/neutron.conf file and complete the following actions

- name: In the [DEFAULT] and [oslo_messaging_rabbit] sections, configure RabbitMQ message queue access
  ini_file:
    dest: /etc/neutron/neutron.conf
    section: DEFAULT
    option: "{{ item.option }}"
    value: "{{ item.value }}"
  with_items:
  - section: DEFAULT
    option: rpc_backend
    value: rabbit
  - section: oslo_messaging_rabbit
    option: rabbit_host
    value: controller
  - section: oslo_messaging_rabbit
    option: rabbit_userid
    value: openstack
  - section: oslo_messaging_rabbit
    option: rabbit_password
    value: "{{ os_messaging_password }}"
  notify: Restart the Networking services

- name: In the [DEFAULT] and [keystone_authtoken] sections, configure Identity service access
  ini_file:
    dest: /etc/neutron/neutron.conf
    section: "{{ item.section }}"
    option: "{{ item.option }}"
    value: "{{ item.value }}"
  with_items:
  - section: DEFAULT
    option: auth_strategy
    value: keystone
  - section: keystone_authtoken
    option: auth_uri
    value: http://{{ os_identity_host }}:5000
  - section: keystone_authtoken
    option: auth_url
    value: http://{{ os_identity_host }}:35357
  - section: keystone_authtoken
    option: auth_plugin
    value: password
  - section: keystone_authtoken
    option: project_domain_id
    value: default
  - section: keystone_authtoken
    option: user_domain_id
    value: default
  - section: keystone_authtoken
    option: project_name
    value: service
  - section: keystone_authtoken
    option: username
    value: neutron
  - section: keystone_authtoken
    option: password
    value: "{{ os_networking_admin_password }}"
  notify: Restart the Networking services

- name: In the [DEFAULT] section, enable the Modular Layer 2 (ML2) plug-in, router service, and overlapping IP addresses
  ini_file:
    dest: /etc/neutron/neutron.conf
    section: DEFAULT
    option: "{{ item.option }}"
    value: "{{ item.value }}"
  with_items:
  - option: core_plugin
    value: ml2
  - option: service_plugins
    value: router
  - option: allow_overlapping_ips
    value: True
  notify: Restart the Networking services

- name: (Optional) To assist with troubleshooting, enable verbose logging in the [DEFAULT] section
  ini_file:
    dest: /etc/neutron/neutron.conf
    section: DEFAULT
    option: verbose
    value: True
  notify: Restart the Networking services

# To configure the Modular Layer 2 (ML2) plug-in
# Edit the /etc/neutron/plugins/ml2/ml2_conf.ini file and complete the following actions

- name: In the [ml2] section, enable the flat, VLAN, generic routing encapsulation (GRE), and virtual extensible LAN (VXLAN) network type drivers, GRE tenant networks, and the OVS mechanism driver
  ini_file:
    dest: /etc/neutron/plugins/ml2/ml2_conf.ini
    section: ml2
    option: "{{ item.option }}"
    value: "{{ item.value }}"
  with_items:
  - option: type_drivers
    value: flat,vlan,gre,vxlan
  - option: tenant_network_types
    value: gre
  - option: mechanism_drivers
    value: openvswitch
  notify: Restart the Networking services

- name: In the [ml2_type_flat] section, configure the external flat provider network
  ini_file:
    dest: /etc/neutron/plugins/ml2/ml2_conf.ini
    section: ml2_type_flat
    option: flat_networks
    value: external
  notify: Restart the Networking services

- name: In the [ml2_type_gre] section, configure the tunnel identifier (id) range
  ini_file:
    dest: /etc/neutron/plugins/ml2/ml2_conf.ini
    section: ml2_type_gre
    option: tunnel_id_ranges
    value: 1:1000
  notify: Restart the Networking services

- name: In the [securitygroup] section, enable security groups, enable ipset, and configure the OVS iptables firewall driver
  ini_file:
    dest: /etc/neutron/plugins/ml2/ml2_conf.ini
    section: securitygroup
    option: "{{ item.option }}"
    value: "{{ item.value }}"
  with_items:
  - option: enable_security_group
    value: True
  - option: enable_ipset
    value: True
  - option: firewall_driver
    value: neutron.agent.linux.iptables_firewall.OVSHybridIptablesFirewallDriver
  notify: Restart the Networking services

- name: In the [ovs] section, enable tunnels, configure the local tunnel endpoint, and map the external flat provider network to the br-ex external network bridge
  ini_file:
    dest: /etc/neutron/plugins/ml2/ml2_conf.ini
    section: ovs
    option: "{{ item.option }}"
    value: "{{ item.value }}"
  with_items:
  - option: local_ip
    value: "{{ os_networking_instance_tunnels_interface_ip_address }}"
  - option: bridge_mappings
    value: external:br-ex
  notify: Restart the Networking services

- name: In the [agent] section, enable GRE tunnels
  ini_file:
    dest: /etc/neutron/plugins/ml2/ml2_conf.ini
    section: agent
    option: tunnel_types
    value: gre
  notify: Restart the Networking services

# To configure the Layer-3 (L3) agent
# Edit the /etc/neutron/l3_agent.ini file and complete the following actions

- name: In the [DEFAULT] section, configure the interface driver, external network bridge, and enable deletion of defunct router namespaces
  ini_file:
    dest: /etc/neutron/l3_agent.ini
    section: DEFAULT
    option: "{{ item.option }}"
    value: "{{ item.value }}"
  with_items:
  - option: interface_driver
    value: neutron.agent.linux.interface.OVSInterfaceDriver
  - option: use_namespaces
    value: True
  - option: external_network_bridge
    value:
  - option: router_delete_namespaces
    value: True
  notify: Restart the Networking services

- name: (Optional) To assist with troubleshooting, enable verbose logging in the [DEFAULT] section
  ini_file:
    dest: /etc/neutron/l3_agent.ini
    section: DEFAULT
    option: verbose
    value: True
  notify: Restart the Networking services

# To configure the DHCP agent
# Edit the /etc/neutron/dhcp_agent.ini file and complete the following actions

- name: In the [DEFAULT] section, configure the interface and DHCP drivers and enable deletion of defunct DHCP namespaces
  ini_file:
    dest: /etc/neutron/dhcp_agent.ini
    section: DEFAULT
    option: "{{ item.option }}"
    value: "{{ item.value }}"
  with_items:
  - option: interface_driver
    value: neutron.agent.linux.interface.OVSInterfaceDriver
  - option: dhcp_driver
    value: neutron.agent.linux.dhcp.Dnsmasq
  - option: dhcp_delete_namespaces
    value: True
  notify: Restart the Networking services

- name: (Optional) To assist with troubleshooting, enable verbose logging in the [DEFAULT] section
  ini_file:
    dest: /etc/neutron/dhcp_agent.ini
    section: DEFAULT
    option: verbose
    value: True
  notify: Restart the Networking services

# you can also prevent MTU problems by reducing the instance MTU to account for GRE overhead.

- name: Edit the /etc/neutron/dhcp_agent.ini file and complete the following action
  ini_file:
    dest: /etc/neutron/dhcp_agent.ini
    section: DEFAULT
    option: dnsmasq_config_file
    value: /etc/neutron/dnsmasq-neutron.conf
  notify: Restart the Networking services

- name: Create and edit the /etc/neutron/dnsmasq-neutron.conf file and complete the following action
  lineinfile:
    dest: /etc/neutron/dnsmasq-neutron.conf
    regexp: ^dhcp-option-force=
    line: dhcp-option-force=26,1454
    create: yes
  notify:
  - Restart the Networking services
  - Kill any existing dnsmasq processes

# To configure the metadata agent
# Edit the /etc/neutron/metadata_agent.ini file and complete the following actions

- name: In the [DEFAULT] section, configure access options
  ini_file:
    dest: /etc/neutron/metadata_agent.ini
    section: DEFAULT
    option: "{{ item.option }}"
    value: "{{ item.value }}"
  with_items:
  - option: auth_uri
    value: http://{{ os_identity_host }}:5000
  - option: auth_url
    value: http://{{ os_identity_host }}:35357
  - option: auth_region
    value: regionOne
  - option: auth_plugin
    value: password
  - option: project_domain_id
    value: default
  - option: user_domain_id
    value: default
  - option: project_name
    value: service
  - option: username
    value: neutron
  - option: password
    value: "{{ os_networking_admin_password }}"
  notify: Restart the Networking services

- name: In the [DEFAULT] section, configure the metadata host
  ini_file:
    dest: /etc/neutron/metadata_agent.ini
    section: DEFAULT
    option: nova_metadata_ip
    value: "{{ os_compute_controller_host }}"
  notify: Restart the Networking services

- name: In the [DEFAULT] section, configure the metadata proxy shared secret
  ini_file:
    dest: /etc/neutron/metadata_agent.ini
    section: DEFAULT
    option: metadata_proxy_shared_secret
    value: "{{ os_networking_metadata_secret }}"
  notify: Restart the Networking services

- name: (Optional) To assist with troubleshooting, enable verbose logging in the [DEFAULT] section
  ini_file:
    dest: /etc/neutron/metadata_agent.ini
    section: DEFAULT
    option: verbose
    value: True
  notify: Restart the Networking services

# On the controller node, edit the /etc/nova/nova.conf file and complete the following action
# See metadata-agent.yml in the compute role

# On the controller node, restart the Compute API service
# See metadata-agent.yml in the compute role

# To configure the Open vSwitch (OVS) service

- name: Restart the OVS service
  service:
    name: openvswitch-switch
    state: restarted

- name: Add the external bridge
  shell: ovs-vsctl add-br br-ex
  ignore_errors: yes

- name: Add a port to the external bridge that connects to the physical external network interface
  shell: ovs-vsctl add-port br-ex {{ os_networking_physical_external_network_interface }}
  ignore_errors: yes
